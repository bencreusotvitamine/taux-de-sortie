<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>TAUX DE SORTIE - Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 24px;
      color: #111827;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      margin-bottom: 16px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
    }
    label {
      font-size: 13px;
      color: #4b5563;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .inline-label {
      flex-direction: row;
      align-items: center;
      gap: 6px;
      margin-top: 16px;
    }
    input[type="text"],
    input[type="number"] {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      min-width: 140px;
    }
    input[type="checkbox"] {
      width: 14px;
      height: 14px;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #008060;
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    #status {
      font-size: 13px;
      color: #4b5563;
      margin-top: 4px;
    }
    .alert-summary {
      font-size: 13px;
      color: #4b5563;
      display: flex;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #fef2f2;
      color: #b91c1c;
      font-size: 12px;
    }
    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #dc2626;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 10px;
      text-align: left;
    }
    th {
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      background: #f9fafb;
      color: #374151;
    }
    .prod-cell {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .prod-img {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      object-fit: cover;
      background: #ccc;
    }
    .prod-text-main {
      font-weight: 600;
      font-size: 13px;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .alert-tag {
      background: #fee2e2;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      color: #b91c1c;
    }
    .chip {
      background: #eef2ff;
      color: #3730a3;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .pct-cell { font-weight: 600; }
    .pct-high { color: #16a34a; }
    .pct-mid  { color: #f97316; }
    .pct-low  { color: #dc2626; }
    .row-low  { background: #fef2f2; }
    .empty {
      text-align: center;
      color: #9ca3af;
      padding: 20px;
    }
  </style>
</head>

<body>
  <h1>TAUX DE SORTIE</h1>
  <div class="subtitle">Suivi saison (balises Shopify) avec r√©assorts, ventes, alertes & taux global.</div>

  <div class="card">
    <div class="controls">
      <label>
        Saison / Balises Shopify
        <input id="season" type="text" placeholder="Ex : ADIDAS, HOMME" />
      </label>

      <label>
        Seuil stock alertes
        <input id="minStockAlert" type="number" value="10" min="0" />
      </label>

      <button id="snapshotBtn">üì∏ D√©finir le stock de d√©part</button>
      <button id="refreshBtn" class="secondary">üîÑ Rafra√Æchir</button>

      <label class="inline-label">
        <input type="checkbox" id="onlyAlerts" />
        <span>Alerte uniquement</span>
      </label>
    </div>

    <div id="status"></div>

    <div id="alertSummary" class="alert-summary" style="display:none;">
      <span class="pill">
        <span class="pill-dot"></span>
        <span id="alertCountText"></span>
      </span>
    </div>
  </div>

  <div class="card">

    <!-- üî• TAUX GLOBAL ICI -->
    <div id="globalStats" style="
      display:flex;
      gap:20px;
      padding:10px 0 20px 0;
      border-bottom:1px solid #e5e7eb;
      margin-bottom:15px;
      flex-wrap:wrap;
    ">
      <div><strong>Stock total :</strong> <span id="globalStock">‚Äî</span></div>
      <div><strong>Vendu :</strong> <span id="globalSold">‚Äî</span></div>
      <div><strong>Taux global :</strong> <span id="globalRate">‚Äî</span></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Produit</th>
          <th>Variante</th>
          <th>Stock base</th>
          <th>R√©assort</th>
          <th>Total saison</th>
          <th>Vendu</th>
          <th>Taux</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7" class="empty">Aucune donn√©e.</td></tr>
      </tbody>
    </table>

  </div>

<script>
  const tbody = document.getElementById("tbody");
  const seasonInput = document.getElementById("season");
  const minStockAlertInput = document.getElementById("minStockAlert");
  const onlyAlertsCheckbox = document.getElementById("onlyAlerts");
  const globalStockEl = document.getElementById("globalStock");
  const globalSoldEl = document.getElementById("globalSold");
  const globalRateEl = document.getElementById("globalRate");
  const alertSummary = document.getElementById("alertSummary");
  const alertCountText = document.getElementById("alertCountText");
  const statusEl = document.getElementById("status");

  let lastRows = [];

  function setStatus(t) { statusEl.textContent = t || ""; }
  function pctClass(p) {
    if (p >= 70) return "pct-high";
    if (p >= 30) return "pct-mid";
    return "pct-low";
  }
  function badgeForPct(p) {
    if (p >= 70) return "üî• Forte";
    if (p >= 30) return "üü† Moyenne";
    return "‚ùÑÔ∏è Faible";
  }
  function getMinStockAlert() {
    const v = parseInt(minStockAlertInput.value, 10);
    if (isNaN(v)) return 0;
    return v;
  }

  function isAlert(row) {
    const base = row.initial_base ?? 0;
    const extra = row.extra_received ?? 0;
    const total = base + extra;
    const sold = row.sold ?? 0;
    const pct = row.sell_through_pct ?? 0;
    const min = getMinStockAlert();

    if (total < min) return false;
    if (sold === 0) return true;
    if (pct < 20) return true;
    return false;
  }

  function renderRows(rows) {
    lastRows = rows || [];

    // üìå CALCUL GLOBAL
    let totalStock = 0, totalSold = 0;

    rows.forEach(r => {
      totalStock += (r.initial_base ?? 0) + (r.extra_received ?? 0);
      totalSold += r.sold ?? 0;
    });

    const globalRate = totalStock > 0 ? (totalSold / totalStock) * 100 : 0;

    globalStockEl.textContent = totalStock;
    globalSoldEl.textContent = totalSold;
    globalRateEl.textContent = globalRate.toFixed(1) + " %";

    // üìå TABLEAU
    const onlyAlerts = onlyAlertsCheckbox.checked;
    const data = onlyAlerts ? rows.filter(isAlert) : rows;

    if (!data.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="empty">Aucune donn√©e.</td></tr>';
      alertSummary.style.display = "none";
      return;
    }

    tbody.innerHTML = "";

    data.forEach(r => {
      const base = r.initial_base ?? 0;
      const extra = r.extra_received ?? 0;
      const total = base + extra;
      const sold = r.sold ?? 0;
      const pct = r.sell_through_pct ?? 0;

      const alert = isAlert(r);
      const tr = document.createElement("tr");
      if (alert) tr.classList.add("row-low");

      tr.innerHTML = `
        <td>
          <div class="prod-cell">
            ${r.image ? `<img src="${r.image}" class="prod-img">` : `<div class="prod-img"></div>`}
            <div>
              <div class="prod-text-main">
                ${r.product_title}
                ${alert ? '<span class="alert-tag">‚ö†Ô∏è Alerte</span>' : ""}
              </div>
            </div>
          </div>
        </td>

        <td><span class="chip">${r.variant_title}</span></td>
        <td>${base}</td>
        <td>${extra}</td>
        <td>${total}</td>
        <td>${sold}</td>
        <td class="${pctClass(pct)} pct-cell">${pct.toFixed(1)} % ‚Äî ${badgeForPct(pct)}</td>
      `;

      tbody.appendChild(tr);
    });

    // R√©sum√© alertes
    const alertCount = rows.filter(isAlert).length;
    if (alertCount > 0) {
      alertCountText.textContent = `${alertCount} produit${alertCount > 1 ? "s" : ""} en alerte`;
      alertSummary.style.display = "flex";
    } else {
      alertSummary.style.display = "none";
    }
  }

  async function refresh() {
    const season = seasonInput.value.trim();
    if (!season) return alert("Saisis une balise");

    setStatus("Chargement‚Ä¶");

    const res = await fetch("/api/sellthrough?season=" + encodeURIComponent(season));
    const data = await res.json();
    setStatus("");
    renderRows(data);
  }

  async function snapshot() {
    const season = seasonInput.value.trim();
    if (!season) return alert("Saisis une balise");

    setStatus("Cr√©ation du snapshot‚Ä¶");

    const res = await fetch("/api/initial_stock/snapshot", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ season })
    });

    const json = await res.json();
    setStatus("Snapshot OK. Actualisation‚Ä¶");
    await refresh();
  }

  document.getElementById("snapshotBtn").onclick = snapshot;
  document.getElementById("refreshBtn").onclick = refresh;
  onlyAlertsCheckbox.onchange = () => renderRows(lastRows);
  minStockAlertInput.onchange = () => renderRows(lastRows);

</script>

</body>
</html>
