<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>TAUX DE SORTIE - Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:20px;background:#f4f6f8;}
    h1{font-size:22px;margin-bottom:16px;}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:16px;}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px;}
    input,select,button{padding:8px 10px;border-radius:8px;border:1px solid #d0d7de;font-size:14px;}
    button{background:#008060;color:#fff;border:none;cursor:pointer;}
    button:disabled{opacity:0.6;cursor:default;}
    table{border-collapse:collapse;width:100%;background:#fff;border-radius:12px;overflow:hidden;}
    th,td{border:1px solid #e1e4e8;padding:8px;font-size:13px;text-align:left;}
    th{background:#f9fafb;font-weight:600;}
    #status{font-size:13px;color:#555;margin-top:6px;}
  </style>
</head>
<body>
  <h1>TAUX DE SORTIE - Dashboard</h1>
  <div class="card">
    <div class="controls">
      <label>Saison :
        <input id="season" placeholder="SS25" value="SS25" />
      </label>
      <button id="snapshot">Définir le stock de départ (snapshot)</button>
      <button id="refresh">Rafraîchir les données</button>
    </div>
    <div id="status"></div>
  </div>

  <div class="card">
    <table id="tbl">
      <thead>
        <tr>
          <th>Variant ID</th>
          <th>SKU</th>
          <th>Stock départ</th>
          <th>Vendu</th>
          <th>Taux de sortie %</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function snapshot() {
      const season = document.getElementById('season').value.trim();
      if (!season) { alert('Indique une saison (ex: SS25)'); return; }
      document.getElementById('status').textContent = 'Snapshot en cours...';
      document.getElementById('snapshot').disabled = true;
      try {
        const r = await fetch('/api/initial_stock/snapshot', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({season})
        });
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || 'Erreur snapshot');
        document.getElementById('status').textContent = 'Snapshot OK : ' + j.inserted + ' variantes enregistrées.';
      } catch(e) {
        console.error(e);
        document.getElementById('status').textContent = 'Erreur snapshot.';
      }
      document.getElementById('snapshot').disabled = false;
      refresh();
    }

    async function refresh() {
      const season = document.getElementById('season').value.trim();
      if (!season) return;
      document.getElementById('status').textContent = 'Chargement...';
      const res = await fetch('/api/sellthrough?season=' + encodeURIComponent(season));
      const data = await res.json();
      const tbl = document.querySelector('#tbl tbody');
      tbl.innerHTML = '';
      data.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + (r.variant_id||'') + '</td>' +
                       '<td>' + (r.sku||'') + '</td>' +
                       '<td>' + (r.initial||0) + '</td>' +
                       '<td>' + (r.sold||0) + '</td>' +
                       '<td>' + (r.sell_through_pct ?? '') + '</td>';
        tbl.appendChild(tr);
      });
      document.getElementById('status').textContent = 'Données mises à jour.';
    }

    document.getElementById('snapshot').addEventListener('click', snapshot);
    document.getElementById('refresh').addEventListener('click', refresh);
    refresh();
  </script>
</body>
</html>
